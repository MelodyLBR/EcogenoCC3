---
title: "Analyse des données avec Dada2"
author : Mélody Lebrun
output: 
date: "14 janvier 2021"
output: 
  github_document:
    toc: true
    toc_depth: 2
---

L'objectif de ce travail ...

Les données choisi proviennent soit du contenue des intestins de 14 Abatus agassizii (oursin) ou des tissus intestinaux ou encore des sédiments à proximité des oursins échantillonnées. L'échantillonnage a été réalisé au niveau de 2 sites séparés par 2 km. Les échantillons ont été séquencé par illumina miseq. Le dossier data_1 contient l'ARNr16s de ces échantillons. 
Le but de dada2 est de préparer les données pour les prochaines analyses en réparant les erreurs de séquençage. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Préparation de l'environnement

```{r}
library(Rcpp)
library(dada2)
```

```{r}
set.seed(100)
```

14 contenus intestinaux, 14 tissus intestinaux, 8 sédiments ARNr16S V4 et V5  
```{r}
miseq_path <- "./data_1"
list.files(miseq_path)
```

## Filtrer et rogner les lectures
# Lire le nom des fichiers et les mettre dans l'ordre

```{r}
fnFs <- sort(list.files(miseq_path, pattern="_1.fastq"))
fnRs <- sort(list.files(miseq_path, pattern="_2.fastq"))
sampleNames <- sapply(strsplit(fnFs, "_"), `[`, 1)
fnFs <- file.path(miseq_path, fnFs)
fnRs <- file.path(miseq_path, fnRs)
fnFs[1:3]
```

```{r}
fnRs[1:3]
```

# Graphique de la qualité des lectures 

```{r}
plotQualityProfile(fnFs[1:2])
```

```{r}
plotQualityProfile(fnRs[1:2])
```
```{r}
filt_path <- file.path(miseq_path, "filtered") 
if(!file_test("-d", filt_path)) dir.create(filt_path)
filtFs <- file.path(filt_path, paste0(sampleNames, "_F_filt.fastq.gz"))
filtRs <- file.path(filt_path, paste0(sampleNames, "_R_filt.fastq.gz"))
```

```{r}
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, truncLen=c(240,160),
              maxN=0, maxEE=c(2,2), truncQ=2, rm.phix=TRUE, compress=TRUE, multithread=TRUE)
head(out)
```

# Déduire des variantes de séquences (ASV)  
Combiner les lectures de séquençage en une séquence unique

```{r message = FALSE}
derepFs <- derepFastq(filtFs, verbose=TRUE)
derepRs <- derepFastq(filtRs, verbose=TRUE)
names(derepFs) <- sampleNames
names(derepRs) <- sampleNames
```
# Connaître le taux d'erreur de séquençage 

```{r}
errF <- learnErrors(filtFs, multithread=TRUE)
```

```{r}
errR <- learnErrors(filtRs, multithread=TRUE)
```

```{r}
plotErrors(errF)
plotErrors(errR)
```

On observe que le taux d'erreur estimé (lignes noires) et le taux d'erreur observé (points noires) sont similaires. (les deux courbes se superposent)

# Méthode d'Interférence de Dada2 pour enlevé les bruits de fond

```{r}
dadaFs <- dada(derepFs, err=errF, multithread=TRUE)
```

```{r}
dadaRs <- dada(derepRs, err=errR, multithread=TRUE)
```

```{r}
dadaFs[[1]]
```

# Construire une table OTU

```{r}
mergers <- mergePairs(dadaFs, derepFs, dadaRs, derepRs)
```

```{r}
seqtabAll <- makeSequenceTable(mergers[!grepl("Mock", names(mergers))])
table(nchar(getSequences(seqtabAll)))
```

Detection des chimères 

```{r}
seqtabNoC <- removeBimeraDenovo(seqtabAll)
```

# Attribuer une taxonomie
```{bash message = FALSE}
cd ~
wget  https://zenodo.org/record/4587955/files/silva_nr99_v138.1_train_set.fa.gz
```

```{r}
fastaRef <-"/home/rstudio/silva_nr99_v138.1_train_set.fa.gz"
taxTab<-assignTaxonomy(seqtabNoC, refFasta=fastaRef, multithread=TRUE)
unname(head(taxTab))
taxa.print <- taxTab # Removing sequence rownames for display only
rownames(taxa.print) <- NULL
head(taxa.print)
```

# Sauvegarde de nos données ASV pour les prochaines analyses 
```{r}
save.image(file="02_Data-analysis-with-DADA2_FinalEnv")
```

## Construire un arbre phylogénétique 

```{r}
seqs <- getSequences(seqtabNoC)
names(seqs) <- seqs 
alignment <- AlignSeqs(DNAStringSet(seqs), anchor=NA,verbose=FALSE)
```

```{r}
phangAlign <- phyDat(as(alignment, "matrix"), type="DNA")
dm <- dist.ml(phangAlign)
treeNJ <- NJ(dm)
fit = pml(treeNJ, data=phangAlign)
fitGTR <- update(fit, k=4, inv=0.2)
fitGTR <- optim.pml(fitGTR, model="GTR", optInv=TRUE, optGamma=TRUE,
        rearrangement = "stochastic", control = pml.control(trace = 0))
detach("package:phangorn", unload=TRUE)
```

## Combiner des données dans un objet phyloseq

```{r}
samdf <- read.csv("https://raw.githubusercontent.com/spholmes/F1000_workflow/master/data/MIMARKS_Data_combined.csv",header=TRUE)
samdf$SampleID <- paste0(gsub("00", "", samdf$host_subject_id), "D", samdf$age-21)
samdf <- samdf[!duplicated(samdf$SampleID),]
rownames(seqtabAll) <- gsub("124", "125", rownames(seqtabAll)) # Fix discrepancy
all(rownames(seqtabAll) %in% samdf$SampleID)
```

```{r}
rownames(samdf) <- samdf$SampleID
keep.cols <- c("collection_date", "biome", "target_gene", "target_subfragment",
"host_common_name", "host_subject_id", "age", "sex", "body_product", "tot_mass",
"diet", "family_relationship", "genotype", "SampleID") 
samdf <- samdf[rownames(seqtabAll), keep.cols]
```

# ici pb non réglé
```{r}
library(phyloseq)
ps <- phyloseq(otu_table(seqtabNoC, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxTab),phy_tree(fitGTR$tree))
ps <- prune_samples(sample_names(ps) != "Mock", ps) # Remove mock sample
ps
```

## Utilisation de phyloseq

```{r}
rank_names(ps) #rang de la base de donnée
table(tax_table(ps)[, "Phylum"], exclude = NULL) # creation d'une table montrant les phylums avec une caractéristique observée
```

```{r}
ps <- subset_taxa(ps, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized")) # supression des phylums non caractérisés
```

```{r}
prevdf = apply(X = otu_table(ps),
               MARGIN = ifelse(taxa_are_rows(ps), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})

prevdf = data.frame(Prevalence = prevdf,
                    TotalAbundance = taxa_sums(ps),
                    tax_table(ps))
# prévalence des caractéristiques dans l'ensemble des données cad le nb de fois que le taxon apparait dans l'échantillon
```

```{r}
plyr::ddply(prevdf, "Phylum", function(df1){cbind(mean(df1$Prevalence),sum(df1$Prevalence))})
# calcule des prévalences totales et moyennes des caractéristiques dans chaque embranchement
```

```{r}
filterPhyla = c("Fusobacteria", "Deinococcus-Thermus")
# Filtrations "supervisées" des phylums dans la base de donnée de référence taxonomique
ps1 = subset_taxa(ps, !Phylum %in% filterPhyla)
ps1
```

# Filtration "non supervisées" reposant sur les données de l'article
```{r}
#lien entre la prévalence et le nombre total de lectures pour chaque caractéristique.

prevdf1 = subset(prevdf, Phylum %in% get_taxa_unique(ps1, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(ps),color=Phylum)) +

  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")
```

```{r}
# Le seuil de prévalence est définie à 5% pour l'ensemble des échantillons
prevalenceThreshold = 0.05 * nsamples(ps)
prevalenceThreshold
```

```{r}
keepTaxa = rownames(prevdf1)[(prevdf1$Prevalence >= prevalenceThreshold)]
ps2 = prune_taxa(keepTaxa, ps)
```

```{r}

```

```{r}

```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
